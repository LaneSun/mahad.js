(t=>{const e=0,i=1,s=2,r=Symbol("data_to"),n=Symbol("data_to_field"),o=(t,e)=>i=>{const s=Symbol();return t.push([i,s]),i.listen(s,e)},h=Object.getOwnPropertyDescriptors(class{get[r](){if(this[n])return this[n];{const t=Array(3).fill(0).map((t=>new Map));return this[n]=t,t}}modify(...t){return this.edit([0,...t])}listen(t,e){return this.set_to(t,{[s]:e},null,!1),this}unlisten(t){this.unset_to(t,!1)}bind_from(t,e,i){return this.clear(),t.set_to(this,e,i),this}bind_clone(t){return this.bind_from(t,{[s]:(t,e,i,s)=>{e.edit(...s)}})}make_bind(t,e){return(new this.constructor).bind_from(this,t,e)}bclone(){return(new this.constructor).bind_clone(this)}}.prototype);delete h.constructor,t.MahadArray=class extends Array{static unfold(t,e){const i=new this;for(;;){let s;if([t,s]=e(t),void 0===s)break;i.push(s)}return i.reverse()}toString(){return`(${this.map((t=>t.toString())).join(" ")})`}get val(){return this[0]}edit(...t){const e=this[r];let i=null;for(const s of t){const[t,r]=s;switch(t){case 0:const t=this.splice(r,s[2],...s[3]);for(const[i,[r,n]]of e[0])r(this,i,n,s,t,s[3]);i=t;break;case 1:const n=this.splice(r,s[2]);this.splice(r+s[3],0,...n);for(const[t,[i,r]]of e[1])i(this,t,r,s,n)}}for(const[i,[s,r]]of[...e[2]])s(this,i,r,t);return i}move(...t){return this.edit([1,...t])}move_at(t,e,i){return this.move(this.indexOf(t),e,i)}move_before(t,e,i){return this.move(this.indexOf(t)-e,e,i)}move_after(t,e,i){return this.move(this.indexOf(t)+1,e,i)}move_range(t,e,i){const s=this.indexOf(t),r=this.indexOf(e)+1;return this.move(s,r-s,i)}exchange(t,e,i=void 0,s=void 0){let r,n,o,h=this.indexOf(t);return void 0===i?(r=h+1,n=this.indexOf(e),o=n+1):void 0===s?(r=this.indexOf(e)+1,n=this.indexOf(i),o=n+1):(r=this.indexOf(e)+1,n=this.indexOf(i),o=this.indexOf(s)+1),[h,r,n,o]=[h,r,n,o].sort(),r===n?this.move(h,r-h,o-n):this.edit([1,h,r-h,n-r],[1,n,o-n,h-n])}modify_at(t,e,i){return this.modify(this.indexOf(t),e,i)}modify_before(t,e,i){return this.modify(this.indexOf(t)-e,e,i)}modify_after(t,e,i){return this.modify(this.indexOf(t)+1,e,i)}modify_range(t,e,i){const s=this.indexOf(t),r=this.indexOf(e)+1;return this.modify(s,r-s,i)}delete(t,e=1){return this.modify(t,e,[])}delete_at(t,e=1){return this.delete(this.indexOf(t),e)}prefix(...t){return this.modify(0,0,t)}postfix(...t){return this.modify(this.length,0,t)}unprefix(t){return this.delete(0,t)}unpostfix(t){return this.delete(this.length-t,t)}assign(t){return this.modify(0,this.length,t)}set(t,e){return this.modify(t,1,[e])}set val(t){this.modify(0,1,[t])}clear(){return this.modify(0,this.length,[])}set_to(t,e,i=[],s=!0){const n=this[r];for(const s in e)n[s].set(t,[e[s],i]);if(s){const s=[0,0,0,this];e[0]?.(this,t,i,s,[],this),e[2]?.(this,t,i,[s])}}unset_to(t,e=!0){if(e){const e=[0,0,this.length,[]],i=this[r][0].get(t);if(i){const[s,r]=i;s(this,t,r,e,this,[])}const s=this[r][2].get(t);if(s){const[i,r]=s;i(this,t,r,[e])}}for(const e of this[r])e.delete(t)}guard(t,i,s){return this.set_to(t,{[e]:(t,e,r,[,n],o,h)=>{if(s)for(let t=o.length-1;t>=0;t--)s(o[t],n+t);if(i)for(let t=0;t<h.length;t++)i(h[t],n+t)}}),this}bind_values(t){return this.bind_from(t,{[e]:(t,e,i,s,r,n)=>{void 0!==r&&e.delete_at(r),void 0!==n&&e.postfix(n)}})}bind_map(t,s){const r=[].guard(null,null,(t=>t.forEach((([t,e])=>t.unlisten(e)))));return this.bind_from(t,{[i]:(t,e,i,s)=>{e.edit(s),i.edit(s)},[e]:(t,e,i,[,r,n,h])=>{const d=[];e.modify(r,n,h.map(((t,n)=>{const h=r+n,c=[],f=()=>{const r=[];e.set(h,s(t,h,o(r,f))),i.set(h,r)},u=s(t,h,o(c,f));return d.push(c),u}))),i.modify(r,n,d)}},r)}bind_reduce(t,i,s){const r=[],n=()=>{r[0]?.forEach((([t,e])=>t.unlisten(e)));const e=[],h=o(e,n);this.val=t.reduce(((t,e,s)=>i(t,e,s,h)),s),r[0]=e};return this.bind_from(t,{[e]:n},r)}bind_sort(t,i){const s=[],r=()=>{s[0]?.forEach((([t,e])=>t.unlisten(e)));const e=[],n=o(e,r);this.assign(t.toSorted(((t,e)=>i(t,e,n)))),s[0]=e};return this.bind_from(t,{[e]:r},s)}bmap(t){return(new this.constructor).bind_map(this,t)}breduce(t,e){return(new this.constructor).bind_reduce(this,t,e)}bsort(t){return(new this.constructor).bind_sort(this,t)}},Object.defineProperties(MahadArray.prototype,h);const d=Object.getOwnPropertyDescriptors(MahadArray.prototype);delete d.constructor,Array.unfold=MahadArray.unfold,Object.defineProperties(Array.prototype,d),t.MahadObject=class extends Object{static unfold(t,e){const i=new this;for(;;){let s;if([t,k,s]=e(t),void 0===s)break;i[k]=s}return i}reduce(t,e){const i=Object.entries(this);e??=i.pop();for(const[s,r]of i)e=t.call(this,e,r,s);return e}toString(){return`(${Object.entries(this).map((([t,e])=>t.toString()+":"+e.toString())).join(" ")})`}edit(...t){const e=this[r];let i=null;for(const s of t){const[t,r,n]=s;if(0===t){const t=this[r];void 0!==n?this[r]=n:delete this[r];for(const[i,[r,o]]of e[0])r(this,i,o,s,t,n);i=t}}for(const[i,[s,r]]of[...e[2]])s(this,i,r,t);return i}delete(...t){return this.edit(t.map((t=>[0,t,void 0])))}assign(t){return this.edit(...Object.entries(this).map((([t])=>[0,t,void 0])),...Object.entries(t).map((([t,e])=>[0,t,e])))}set(t,e){return this.edit([0,t,e])}clear(){return this.edit(...Object.entries(this).map((([t])=>[0,t,void 0])))}set_to(t,e,i=[],s=!0){const n=this[r];for(const s in e)n[s].set(t,[e[s],i]);if(s){const s=Object.entries(this).map((([t,e])=>[0,t,e]));for(const r of s)e[0]?.(this,t,i,r,void 0,r[2]);e[2]?.(this,t,i,s)}}unset_to(t,e=!0){if(e){const e=Object.entries(this).map((([t,e])=>[[0,t,void 0],e])),i=this[r][0].get(t);if(i){const[s,r]=i;for(const[i,n]of e)s(this,t,r,i,n,void 0)}const s=this[r][2].get(t);if(s){const[i,r]=s;i(this,t,r,e.map((t=>t[0])))}}for(const e of this[r])e.delete(t)}guard(t,i,s){return this.set_to(t,{[e]:(t,e,r,[,n],o,h)=>{s&&void 0!==o&&s(o,n),i&&void 0!==h&&i(h,n)}}),this}bind_map(t,i){const s={}.guard(null,null,(t=>t.forEach((([t,e])=>t.unlisten(e)))));return this.bind_from(t,{[e]:(t,e,s,[,r,n])=>{if(void 0!==n){const t=[],h=()=>{const t=[];e.set(r,i(n,r,o(t,h))),s.set(r,t)};e.modify(r,i(n,r,o(t,h))),s.set(r,t)}else e.modify(r,n),s.modify(r,n)}},s)}bind_reduce(t,e,i){const r=[],n=()=>{r[0]?.forEach((([t,e])=>t.unlisten(e)));const s=[],h=o(s,n);this.val=t.reduce(((t,i,s)=>e(t,i,s,h)),i),r[0]=s};return this.bind_from(t,{[s]:n},r)}bvalues(){return(new Array).bind_values(this)}bmap(t){return(new this.constructor).bind_map(this,t)}breduce(t,e){return(new this.constructor).bind_reduce(this,t,e)}},Object.defineProperties(MahadObject.prototype,h);const c=Object.getOwnPropertyDescriptors(MahadObject.prototype);delete c.constructor,Object.unfold=MahadObject.unfold,Object.defineProperties(Object.prototype,c)})(globalThis);